<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Open Claw — Intelligence Dashboard</title>
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2234;
  --border: #2a3548;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --green: #22c55e;
  --green-dim: #166534;
  --red: #ef4444;
  --red-dim: #991b1b;
  --amber: #f59e0b;
  --blue: #3b82f6;
  --purple: #a855f7;
  --cyan: #06b6d4;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', 'Cascadia Code', monospace;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
}

/* ── Header ─────────────────────────────────────────── */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 24px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
}
.header-left { display: flex; align-items: center; gap: 16px; }
.logo { font-size: 18px; font-weight: 700; letter-spacing: 1px; }
.logo span { color: var(--green); }
.version { font-size: 11px; color: var(--text-muted); background: var(--bg-card); padding: 2px 8px; border-radius: 4px; }
.header-stats { display: flex; gap: 24px; font-size: 12px; color: var(--text-secondary); }
.header-stats .stat-val { color: var(--text-primary); font-weight: 600; }
.status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
.status-dot.ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
.status-dot.err { background: var(--red); }
.refresh-info { font-size: 11px; color: var(--text-muted); }

/* ── Layout ─────────────────────────────────────────── */
.grid {
  display: grid;
  grid-template-columns: 3fr 2fr;
  grid-template-rows: auto auto;
  gap: 16px;
  padding: 16px 24px;
  max-width: 1800px;
  margin: 0 auto;
}
.signal-feed { grid-row: 1 / 3; }

/* ── Cards ──────────────────────────────────────────── */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.card-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 12px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1px; color: var(--text-secondary);
}
.card-header .count { color: var(--text-muted); font-weight: 400; }
.card-body { padding: 12px 16px; }

/* ── Signal Feed ────────────────────────────────────── */
.signal-item {
  display: grid;
  grid-template-columns: 64px 1fr auto;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.signal-item:last-child { border-bottom: none; }
.signal-dir {
  font-weight: 700; font-size: 13px;
  padding: 4px 8px; border-radius: 4px;
  text-align: center; align-self: start;
}
.signal-dir.LONG { background: var(--green-dim); color: var(--green); }
.signal-dir.SHORT { background: var(--red-dim); color: var(--red); }
.signal-dir.HEDGE { background: #44337a; color: var(--purple); }
.signal-body h4 { font-size: 13px; margin-bottom: 4px; }
.signal-body h4 .sym { color: var(--cyan); }
.signal-body h4 .type { color: var(--text-muted); font-weight: 400; margin-left: 8px; font-size: 11px; }
.signal-thesis { color: var(--text-secondary); font-size: 12px; line-height: 1.5; margin-top: 4px; }
.signal-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; font-size: 11px; color: var(--text-muted); white-space: nowrap; }
.conviction-bar { width: 60px; height: 6px; background: var(--bg-primary); border-radius: 3px; overflow: hidden; }
.conviction-fill { height: 100%; border-radius: 3px; }
.conviction-high { background: var(--green); }
.conviction-mid { background: var(--amber); }
.conviction-low { background: var(--red); }
.badge { font-size: 10px; padding: 2px 6px; border-radius: 3px; }
.badge-horizon { background: #1e3a5f; color: var(--blue); }

/* ── Entity Tracker ─────────────────────────────────── */
.entity-table { width: 100%; font-size: 12px; }
.entity-table th {
  text-align: left; padding: 6px 8px; color: var(--text-muted);
  font-weight: 500; border-bottom: 1px solid var(--border);
}
.entity-table td { padding: 8px; border-bottom: 1px solid var(--border); }
.entity-table tr:last-child td { border-bottom: none; }
.entity-name { font-weight: 600; }
.entity-type { font-size: 10px; color: var(--text-muted); }
.entity-ticker { color: var(--cyan); font-weight: 600; }
.sentiment-pos { color: var(--green); }
.sentiment-neg { color: var(--red); }
.sentiment-neu { color: var(--text-muted); }

/* ── Ingestion Monitor ──────────────────────────────── */
.monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.monitor-stat { text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 6px; }
.monitor-stat .val { font-size: 24px; font-weight: 700; color: var(--text-primary); }
.monitor-stat .label { font-size: 10px; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
.platform-bars { margin-top: 12px; }
.platform-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 11px; }
.platform-row .name { width: 80px; color: var(--text-secondary); text-align: right; }
.platform-row .bar-bg { flex: 1; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; }
.platform-row .bar-fill { height: 100%; background: var(--blue); border-radius: 4px; transition: width 0.3s; }
.platform-row .count { width: 40px; color: var(--text-muted); text-align: right; }

/* ── Summary row ────────────────────────────────────── */
.summary-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  padding: 0 24px 16px;
  max-width: 1800px;
  margin: 0 auto;
}
.summary-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 8px; padding: 16px; text-align: center;
}
.summary-card .val { font-size: 28px; font-weight: 700; }
.summary-card .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; letter-spacing: 0.5px; }
.val-green { color: var(--green); }
.val-blue { color: var(--blue); }
.val-amber { color: var(--amber); }
.val-purple { color: var(--purple); }

/* ── Footer ─────────────────────────────────────────── */
.footer {
  text-align: center; padding: 16px;
  font-size: 11px; color: var(--text-muted);
  border-top: 1px solid var(--border);
}

/* ── Loading state ──────────────────────────────────── */
.loading { text-align: center; padding: 40px; color: var(--text-muted); }
.spin { display: inline-block; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- ─── HEADER ─────────────────────────────────────── -->
<header class="header">
  <div class="header-left">
    <div class="logo">OPEN<span>CLAW</span></div>
    <span class="version" id="hdr-version">v-</span>
    <span><span class="status-dot" id="hdr-dot"></span><span id="hdr-status">connecting...</span></span>
  </div>
  <div class="header-stats">
    <span>Uptime: <span class="stat-val" id="hdr-uptime">-</span></span>
    <span>Mock: <span class="stat-val" id="hdr-mock">-</span></span>
    <span class="refresh-info">auto-refresh 10s</span>
  </div>
</header>

<!-- ─── SUMMARY ROW ────────────────────────────────── -->
<div class="summary-row" style="padding-top:16px">
  <div class="summary-card"><div class="val val-green" id="sum-signals">-</div><div class="label">Signals</div></div>
  <div class="summary-card"><div class="val val-blue" id="sum-entities">-</div><div class="label">Entities</div></div>
  <div class="summary-card"><div class="val val-amber" id="sum-posts">-</div><div class="label">Posts Scraped</div></div>
  <div class="summary-card"><div class="val val-purple" id="sum-killrate">-</div><div class="label">Kill Rate</div></div>
</div>

<!-- ─── MAIN GRID ──────────────────────────────────── -->
<div class="grid">
  <!-- Signal Feed -->
  <div class="card signal-feed">
    <div class="card-header">Signal Feed <span class="count" id="sig-count">0 signals</span></div>
    <div class="card-body" id="signal-list"><div class="loading"><span class="spin">&#9696;</span> Loading signals...</div></div>
  </div>

  <!-- Entity Tracker -->
  <div class="card">
    <div class="card-header">Entity Tracker <span class="count" id="ent-count">0 entities</span></div>
    <div class="card-body" id="entity-list"><div class="loading"><span class="spin">&#9696;</span> Loading entities...</div></div>
  </div>

  <!-- Ingestion Monitor -->
  <div class="card">
    <div class="card-header">Ingestion Monitor</div>
    <div class="card-body" id="monitor-body"><div class="loading"><span class="spin">&#9696;</span> Loading stats...</div></div>
  </div>
</div>

<!-- ─── FOOTER ─────────────────────────────────────── -->
<footer class="footer">Open Claw — Social Media Intelligence Platform &middot; <span id="ftr-time">-</span></footer>

<script>
const API = '/api';
let lastRefresh = null;

// ── Helpers ──────────────────────────────────────────
function timeAgo(iso) {
  const diff = (Date.now() - new Date(iso).getTime()) / 1000;
  if (diff < 60) return Math.round(diff) + 's ago';
  if (diff < 3600) return Math.round(diff / 60) + 'm ago';
  if (diff < 86400) return Math.round(diff / 3600) + 'h ago';
  return Math.round(diff / 86400) + 'd ago';
}
function fmtUptime(s) {
  const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60);
  return h > 0 ? h + 'h ' + m + 'm' : m + 'm ' + Math.round(s % 60) + 's';
}
function sentClass(v) { return v > 0.1 ? 'sentiment-pos' : v < -0.1 ? 'sentiment-neg' : 'sentiment-neu'; }
function convClass(v) { return v >= 0.7 ? 'conviction-high' : v >= 0.5 ? 'conviction-mid' : 'conviction-low'; }

// ── Fetch wrappers ───────────────────────────────────
async function fetchJSON(path) {
  const res = await fetch(API + path);
  if (!res.ok) throw new Error(res.status);
  return res.json();
}

// ── Health / Header ──────────────────────────────────
async function refreshHealth() {
  try {
    const h = await fetchJSON('/health');
    document.getElementById('hdr-version').textContent = 'v' + h.version;
    document.getElementById('hdr-uptime').textContent = fmtUptime(h.uptime_seconds);
    document.getElementById('hdr-mock').textContent = h.mock_mode ? 'ON' : 'OFF';
    const dot = document.getElementById('hdr-dot');
    const st = document.getElementById('hdr-status');
    if (h.status === 'ok') {
      dot.className = 'status-dot ok'; st.textContent = 'online';
    } else {
      dot.className = 'status-dot err'; st.textContent = 'degraded';
    }
  } catch {
    document.getElementById('hdr-dot').className = 'status-dot err';
    document.getElementById('hdr-status').textContent = 'offline';
  }
}

// ── Stats / Summary ──────────────────────────────────
async function refreshStats() {
  try {
    const s = await fetchJSON('/stats');
    document.getElementById('sum-signals').textContent = s.signals.total;
    document.getElementById('sum-entities').textContent = s.brain.entities_extracted || s.brain.posts_analyzed || '-';
    document.getElementById('sum-posts').textContent = s.swarm.total_posts;
    document.getElementById('sum-killrate').textContent = (s.gatekeeper.kill_rate * 100).toFixed(1) + '%';
  } catch {}
}

// ── Signals ──────────────────────────────────────────
async function refreshSignals() {
  try {
    const signals = await fetchJSON('/signals?limit=30');
    const el = document.getElementById('signal-list');
    document.getElementById('sig-count').textContent = signals.length + ' signals';
    if (!signals.length) { el.innerHTML = '<div class="loading">No signals yet</div>'; return; }
    el.innerHTML = signals.map(s => {
      const syms = (s.affected_instruments || []).map(i => i.symbol).join(', ');
      const conv = s.conviction || 0;
      return `<div class="signal-item">
        <div class="signal-dir ${s.direction}">${s.direction}</div>
        <div class="signal-body">
          <h4><span class="sym">${syms}</span><span class="type">${s.signal_type}</span></h4>
          <div class="signal-thesis">${(s.thesis || '').substring(0, 200)}</div>
        </div>
        <div class="signal-meta">
          <span>${timeAgo(s.created_at)}</span>
          <div class="conviction-bar"><div class="conviction-fill ${convClass(conv)}" style="width:${conv*100}%"></div></div>
          <span>${(conv*100).toFixed(0)}% conv</span>
          <span class="badge badge-horizon">${s.time_horizon || '-'}</span>
        </div>
      </div>`;
    }).join('');
  } catch { document.getElementById('signal-list').innerHTML = '<div class="loading">Failed to load signals</div>'; }
}

// ── Entities ─────────────────────────────────────────
async function refreshEntities() {
  try {
    const ents = await fetchJSON('/entities?limit=20');
    const el = document.getElementById('entity-list');
    document.getElementById('ent-count').textContent = ents.length + ' entities';
    if (!ents.length) { el.innerHTML = '<div class="loading">No entities yet</div>'; return; }
    el.innerHTML = `<table class="entity-table">
      <tr><th>Entity</th><th>Ticker</th><th>Sentiment</th><th>Conf</th><th>Mentions</th></tr>
      ${ents.map(e => {
        const sent = e.latest_sentiment;
        const sentStr = sent !== null ? (sent > 0 ? '+' : '') + sent.toFixed(2) : '-';
        return `<tr>
          <td><span class="entity-name">${e.name}</span><br><span class="entity-type">${e.entity_type}</span></td>
          <td class="entity-ticker">${e.ticker || '-'}</td>
          <td class="${sentClass(sent)}">${sentStr}</td>
          <td>${e.sentiment_confidence ? (e.sentiment_confidence * 100).toFixed(0) + '%' : '-'}</td>
          <td>${e.mention_count || 0}</td>
        </tr>`;
      }).join('')}
    </table>`;
  } catch { document.getElementById('entity-list').innerHTML = '<div class="loading">Failed to load entities</div>'; }
}

// ── Ingestion Monitor ────────────────────────────────
async function refreshMonitor() {
  try {
    const s = await fetchJSON('/stats');
    const sw = s.swarm || {};
    const gk = s.gatekeeper || {};
    const plats = sw.by_platform || {};
    const maxPlat = Math.max(...Object.values(plats), 1);
    const platHTML = Object.entries(plats).sort((a,b) => b[1]-a[1]).slice(0, 10).map(([name, count]) =>
      `<div class="platform-row">
        <span class="name">${name}</span>
        <div class="bar-bg"><div class="bar-fill" style="width:${(count/maxPlat*100).toFixed(1)}%"></div></div>
        <span class="count">${count}</span>
      </div>`
    ).join('');

    document.getElementById('monitor-body').innerHTML = `
      <div class="monitor-grid">
        <div class="monitor-stat"><div class="val">${sw.total_posts || 0}</div><div class="label">Total Scraped</div></div>
        <div class="monitor-stat"><div class="val">${sw.posts_per_minute || 0}/m</div><div class="label">Ingest Rate</div></div>
        <div class="monitor-stat"><div class="val">${gk.total_kept || 0}</div><div class="label">Kept</div></div>
        <div class="monitor-stat"><div class="val">${gk.total_killed || 0}</div><div class="label">Killed</div></div>
      </div>
      <div class="platform-bars">${platHTML}</div>`;
  } catch { document.getElementById('monitor-body').innerHTML = '<div class="loading">Failed to load stats</div>'; }
}

// ── Refresh loop ─────────────────────────────────────
async function refreshAll() {
  await Promise.allSettled([
    refreshHealth(),
    refreshStats(),
    refreshSignals(),
    refreshEntities(),
    refreshMonitor(),
  ]);
  lastRefresh = new Date();
  document.getElementById('ftr-time').textContent = lastRefresh.toLocaleTimeString();
}

refreshAll();
setInterval(refreshAll, 10000);
</script>
</body>
</html>
